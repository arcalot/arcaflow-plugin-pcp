# Performance Copilot (PCP) Plugin

This plugin runs PCP pmlogger, collects data until cancelled,
and then generates a structured output of the results.

***Note:** This plugin runs indefinitely until explicitly cancelled.
When used as a stand-alone plugin, the data collection can be stopped
with `Ctrl-c`. When used in an Arcaflow workflow, the `stop_if`
option should be used to send the `cancel` signal to the plugin based
on the status of another plugin.*

Workflow example snippet with `stop_if`:
```yaml
steps:
  pcp:
    plugin: quay.io/arcalot/arcaflow-plugin-pcp:latest
    step: start-pcp
    input: !expr $.input.pcp_params
    stop_if: !expr $.steps.sysbench.outputs
  sysbench:
    plugin: quay.io/arcalot/arcaflow-plugin-sysbench:latest
    step: sysbenchcpu
    input: !expr $.input.sysbench_params
```

## Using the plugin
Build the container:
```
docker build . -t arcaflow-plugin-pcp
```

Run with the provided example input:
```
cat configs/pcp_example.yaml | docker run -i --rm arcaflow-plugin-pcp -f -
```

***Note:** This plugin is designed to be used as a container image built with
the provided Dockerfile. Using the python directly on a target system will
likely prove problematic*

## Container Privileged Mode

Note that some metrics collected by PCP are in fact at the host system level
even when running in a non-privileged container, but many metrics are
namespace-scoped. In order to collect all metrics at the host level, you will
need to run the containerized plugin in privileged mode with host networking.

## Power User Configurations

***Please exercise caution in using the configuration options noted here.
There is no input validation for the custom configurations, and malformed
entries will lead to a plugin failure, possibly late in the run.***

### pmlogger config files
Under normal operation, the plugin generates for itself a default configuration
file for pmlogger using the `pmlogconf` command. In most circumstances, this
is likely adequate, and no special actions or input are needed from the user for
the configuration.

For experienced users of pmlogger who would like to specify a custom configuration,
the input schema for the plugin does allow a **complete** pmlogger config file to
be included in the input as a multi-line string to the `pmlogger_conf` key.

### pcp2json/pmrep config files
The container will deploy with a standard set of `pmrep` configuration files 
internally under `/etc/pcp/pmrep/`. An experienced user may also pass a **complete**
pmrep config file as a multi-line string to the `pmrep_conf` key.

### pcp2json/pmrep metrics
Any metrics or metricsets defined in the pmrep config file(s) can be referenced
in the standard `pmrep` format, with which the `pcp2json` command is compatible.
The desired metrics/sets are optionally passed as a string to the `pmlogger_metrics`
key in the input. If nothing is provided to this key in the input, the default value
documented below will be used.

# Autogenerated Input/Output Documentation by Arcaflow-Docsgen Below

<!-- Autogenerated documentation by arcaflow-docsgen -->
<!-- End of autogenerated documentation -->
